# ContextCore Loki Alert Rules
# Convention: ContextCore[Resource][Issue]
# See: docs/semantic-conventions.md (Alert Naming Convention)

groups:
  - name: contextcore_alerts
    rules:
      - alert: ContextCoreExporterFailure
        expr: |
          count_over_time(
            {service="contextcore"} | json
            | severity_text = "ERROR"
            | body =~ ".*OTLP.*export.*fail.*|.*exporter.*error.*" [5m]
          ) > 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "OTLP exporter failure detected"
          description: "ContextCore OTLP export errors in last 5m. Health reporting impacted."
          runbook_url: "docs/OPERATIONAL_RUNBOOK.md#otlp-exporter-failure"

      - alert: ContextCoreSpanStateLoss
        expr: |
          count_over_time(
            {service="contextcore"} | json
            | severity_text = "ERROR"
            | body =~ ".*state.*persist.*fail.*|.*span.*state.*lost.*" [5m]
          ) > 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Span state persistence failure"
          description: "In-flight spans may be lost on restart."
          runbook_url: "docs/OPERATIONAL_RUNBOOK.md#span-state-loss"

  # NOTE: Task-stalled alert removed from Loki rules. The previous expression used
  # PromQL-only functions (time(), timestamp()) which are invalid in LogQL.
  # A per-task stalled alert should be implemented as a metric rule in Mimir.
