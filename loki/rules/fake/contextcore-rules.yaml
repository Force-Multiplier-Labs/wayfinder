# ContextCore Loki Recording Rules
# Convention: <aggregation_level>:<base_metric>:<aggregation_function>
# See: docs/semantic-conventions.md (Recording Rule Naming Convention)

groups:
  - name: contextcore_task_progress
    interval: 1m
    rules:
      # NOTE: These rules use PromQL-style expressions and are not valid LogQL.
      # They should be implemented as Mimir recording rules instead of Loki.
      # Loki LogQL recording rules must be based on log stream expressions.

  - name: contextcore_task_status
    interval: 1m
    rules:
      # Task count grouped by status (LogQL-compatible)
      - record: "project:contextcore_task_count:count_by_status"
        expr: |
          count by (project_id, to_status) (
            {service="contextcore"} | json
            | event = "task.status_changed"
          )
        labels:
          source: loki
