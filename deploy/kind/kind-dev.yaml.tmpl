# Wayfinder Kind Cluster - Dev Profile
# 2-node setup: control-plane + 1 combined worker
# Template: __WAYFINDER_ROOT__ is resolved by create-cluster.sh at runtime
#
# For multi-node topology with criticality tiers, use kind-test.yaml.tmpl

kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: wayfinder-dev
nodes:
  # Control plane with port mappings for local access
  - role: control-plane
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
    extraPortMappings:
      # Grafana
      - containerPort: 30000
        hostPort: 3000
        protocol: TCP
      # Loki
      - containerPort: 30100
        hostPort: 3100
        protocol: TCP
      # Mimir
      - containerPort: 30009
        hostPort: 9009
        protocol: TCP
      # Tempo
      - containerPort: 30200
        hostPort: 3200
        protocol: TCP
      # Alloy UI
      - containerPort: 31234
        hostPort: 12345
        protocol: TCP
      # OTLP gRPC
      - containerPort: 30317
        hostPort: 4317
        protocol: TCP
      # OTLP HTTP
      - containerPort: 30318
        hostPort: 4318
        protocol: TCP
    extraMounts:
      # ContextCore Grafana plugins (Owl / Gookooko'oo)
      - hostPath: __WAYFINDER_ROOT__/contextcore-owl/grafana/plugins
        containerPath: /plugins/contextcore
        readOnly: true

  # Combined worker: runs all workloads (observability + application)
  - role: worker
    kubeadmConfigPatches:
      - |
        kind: JoinConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "contextcore.io/criticality=workload,contextcore.io/purpose=all"
    extraMounts:
      - hostPath: __WAYFINDER_ROOT__/contextcore-owl/grafana/plugins
        containerPath: /plugins/contextcore
        readOnly: true
